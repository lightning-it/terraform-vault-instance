# yamllint disable rule:truthy
---
name: Terraform Module CI & Semantic Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:

permissions:
  contents: read

jobs:
  terraform-module:
    name: Terraform module checks (Terraform ${{ matrix.terraform_version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        terraform_version: ["1.12.1"]

    defaults:
      run:
        shell: bash

    steps:
      # 1) Checkout the repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Install Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          terraform_version: ${{ matrix.terraform_version }}

      # 3) Format check in the module root
      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      # 4) Init without backend (we are testing a module, no state)
      - name: Terraform init (module root)
        run: terraform init -backend=false

      # 5) Validate module configuration
      - name: Terraform validate (module root)
        run: terraform validate

      # 6) Validate test fixtures
      - name: Terraform validate (test fixtures)
        run: |
          terraform init -backend=false
          terraform validate

      # 7) TFLint across the repo
      # - name: TFLint (via wunder-devtools-ee)
        # run: bash scripts/wunder-devtools-ee.sh tflint --recursive

  # Real release job: only runs on push to main
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: terraform-module
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write       # required to create tags and releases
      issues: write         # optional, for release notes references
      pull-requests: write  # optional, for release notes references
    env:
      GITHUB_TOKEN: ${{ github.token }}
    steps:
      # Checkout with full history for semantic-release
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # semantic-release needs full history

      # Setup Node for semantic-release
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # Install Node dependencies from package-lock.json
      - name: Install dependencies
        run: npm ci

      # Run semantic-release (real release)
      - name: Run semantic-release
        run: npx semantic-release

  # Dry-run job: checks semantic-release config on pull requests
  release_dry_run:
    name: Semantic Release (dry run)
    runs-on: ubuntu-latest
    needs: terraform-module
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    env:
      GITHUB_TOKEN: ${{ github.token }}
    steps:
      # Checkout with full history to let semantic-release inspect tags/commits
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node for semantic-release
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # Install Node dependencies from package-lock.json
      - name: Install dependencies
        run: npm ci

      # Run semantic-release in dry-run mode (no tags, no releases, no commits)
      - name: Run semantic-release (dry run)
        run: npx semantic-release --dry-run --no-ci
